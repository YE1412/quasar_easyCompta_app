import { s as sessionAxiosService } from "./session.service.js";
import { i as i18n, P as Platform, a as Plugin } from "./index.js";
import { getPref, setPref } from "./index3.js";
import "./index4.js";
import "./index2.js";
const t = i18n.global.t;
async function validateSession(sessionCookie, platform, sessionPref = null) {
  if (platform.is.desktop)
    return sessionAxiosService.validate(!!sessionCookie ? sessionCookie.sessionId : "");
  else {
    if (!!sessionPref && !!sessionCookie && sessionPref.sessionId === sessionCookie.sessionId)
      return true;
    else
      return false;
  }
}
function hasNecessaryRoute(to, router) {
  let ret = false;
  ret = router.hasRoute(to.name);
  return ret;
}
async function routingForClient(store, cookie, from, to, router, platform) {
  let sessionCookie = null, userCookie = null;
  if (!!cookie.getAll().session) {
    sessionCookie = JSON.parse(decodeURIComponent(cookie.getAll().session));
  }
  if (!!cookie.getAll().user) {
    userCookie = JSON.parse(decodeURIComponent(cookie.getAll().user));
  }
  if (!!cookie.getAll().message) {
    JSON.parse(decodeURIComponent(cookie.getAll().message));
  }
  i18n.global.locale.value = !!sessionCookie && !!sessionCookie.langDisplayed ? sessionCookie.langDisplayed.nom : "en-US";
  const hasRoute = hasNecessaryRoute(to, router);
  const requireAuth = to.meta.requiresAuth;
  if (requireAuth && !!userCookie && !userCookie.connected) {
    return await validateSession(sessionCookie, platform).then(
      () => {
        if (!!userCookie.user && Object.keys(userCookie.user).length && Object.getPrototypeOf(userCookie.user) === Object.prototype) {
          store.user.connected = true;
          userCookie.connected = true;
          cookie.set("user", JSON.stringify(userCookie), { path: "/", sameSite: "Lax", secure: false });
          return null;
        } else {
          return t("startLinkTarget");
        }
      }
    ).catch(() => {
      if (!!store && Object.keys(store).length && Object.getPrototypeOf(store) === Object.prototype) {
        store.user.user = [];
        store.user.connected = false;
      }
      if (store.session && store.session.sessionId != "") {
        store.message.messages.push({
          severity: true,
          content: t("session.results.ko")
        });
        store.message.messagesVisibility = true;
      } else {
        if (!!store && Object.keys(store).length && Object.getPrototypeOf(store) === Object.prototype) {
          store.message.messages = [];
          store.message.messagesVisibility = false;
        }
      }
      return t("startLinkTarget");
    });
  } else if (hasRoute && to.fullPath !== "/") {
    if (to.fullPath === t("startLinkTarget")) {
      if (userCookie === null) {
        userCookie = {};
        userCookie.user = {};
      }
      userCookie.connected = false;
      cookie.set("user", JSON.stringify(userCookie), { path: "/", sameSite: "Lax", secure: false });
    }
    return null;
  } else if (userCookie === null || !Object.keys(userCookie.user).length && Object.getPrototypeOf(userCookie.user) === Object.prototype && hasRoute) {
    if (userCookie === null) {
      userCookie = {};
      userCookie.user = {};
    }
    userCookie.connected = false;
    cookie.set("user", JSON.stringify(userCookie), { path: "/", sameSite: "Lax", secure: false });
    return t("startLinkTarget");
  } else
    return null;
}
async function checkForWeb(to, from, next, router, cookie, platform, store = null) {
  let dest = null;
  {
    dest = await routingForClient(store, cookie, from, to, router, platform);
  }
  if (!!dest)
    next(dest);
  else
    next();
}
async function checkForMobiles(to, from, next, router, cookie, platform) {
  let sessionCookie = null, userCookie = null;
  if (!!cookie.getAll().session) {
    sessionCookie = JSON.parse(decodeURIComponent(cookie.getAll().session));
  }
  if (!!cookie.getAll().user) {
    userCookie = JSON.parse(decodeURIComponent(cookie.getAll().user));
  }
  i18n.global.locale.value = !!sessionCookie && !!sessionCookie.langDisplayed ? sessionCookie.langDisplayed.nom : "en-US";
  const hasRoute = hasNecessaryRoute(to, router);
  const requireAuth = to.meta.requiresAuth;
  if (requireAuth && !!userCookie && !userCookie.connected) {
    const sessionPref = await getPref("session");
    const res = await validateSession(sessionCookie, platform, sessionPref);
    if (res) {
      console.log("Session validated !");
      if (!!userCookie.user && Object.keys(userCookie.user).length && Object.getPrototypeOf(userCookie.user) === Object.prototype) {
        userCookie.connected = true;
        await setPref("user", userCookie);
        next();
      } else {
        await setPref("message", {
          messages: [
            {
              severity: true,
              content: t("session.results.ko")
            }
          ],
          messagesVisibility: true
        });
        next(t("startLinkTarget"));
      }
    } else {
      console.log("Session unvalidated !");
      await setPref("user", { connected: false, user: {} });
      if (sessionCookie && sessionCookie.sessionId !== "") {
        await setPref("message", {
          messages: [
            {
              severity: true,
              content: t("session.results.ko")
            }
          ],
          messagesVisibility: true
        });
      } else {
        await setPref("message", {
          messages: [],
          messagesVisibility: false
        });
      }
      next(t("startLinkTarget"));
    }
  } else if (hasRoute && to.fullPath !== "/") {
    next();
  } else if (userCookie === null && hasRoute) {
    next(t("startLinkTarget"));
  } else
    next();
}
var auth = ({ store, router, ssrContext }) => {
  const platform = Platform;
  const cookies = Plugin;
  router.beforeEach(async (to, from, next) => {
    if (platform.is.desktop) {
      await checkForWeb(to, from, next, router, cookies, platform, store.state.value);
    } else {
      await checkForMobiles(to, from, next, router, cookies, platform);
    }
  });
};
export { auth as default };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2Jvb3QvYXV0aC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKmVzbGludCBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55OiAnb2ZmJyovXG4vKmVzbGludCBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW51c2VkLXZhcnM6IG9mZiovXG5cbmltcG9ydCBzZXNzaW9uQXhpb3NTZXJ2aWNlIGZyb20gJ2FwcC9zcmMvZGIvc2VydmljZXMvc2Vzc2lvbi5zZXJ2aWNlJztcbmltcG9ydCB7IGkxOG4gfSBmcm9tICdhcHAvc3JjL2Jvb3QvaTE4bic7XG5pbXBvcnQgeyBQbGF0Zm9ybSwgQ29va2llcyB9IGZyb20gJ3F1YXNhcic7XG5pbXBvcnQgKiBhcyBwcmVmcyBmcm9tICdhcHAvc3JjL2NhcGFjaXRvci9zdG9yYWdlL3ByZWZlcmVuY2VzJztcblxuY29uc3QgdCA9IGkxOG4uZ2xvYmFsLnQ7XG4vLyBjb25zdCBwYXRoc09iaiA9IFtcbi8vICAge1xuLy8gICAgIGNvbXBvbmVudDogKCkgPT4gaW1wb3J0KCdhcHAvc3JjL3BhZ2VzL1N0YXJ0UGFnZS52dWUnKSxcbi8vICAgICBhdXRoOiBmYWxzZSxcbi8vICAgICB0YXJnZXQ6ICdzdGFydExpbmtUYXJnZXQnLFxuLy8gICAgIHRhcmdldE5hbWU6ICdzdGFydExpbmtOYW1lJyxcbi8vICAgICB0aXRsZTogJ3N0YXJ0VGl0bGUnLFxuLy8gICB9LFxuLy8gICB7XG4vLyAgICAgY29tcG9uZW50OiAoKSA9PiBpbXBvcnQoJ2FwcC9zcmMvcGFnZXMvUmVnaXN0ZXJQYWdlLnZ1ZScpLFxuLy8gICAgIGF1dGg6IGZhbHNlLFxuLy8gICAgIHRhcmdldDogJ3JlZ2lzdGVyTGlua1RhcmdldCcsXG4vLyAgICAgdGFyZ2V0TmFtZTogJ3JlZ2lzdGVyTGlua05hbWUnLFxuLy8gICAgIHRpdGxlOiAncmVnaXN0ZXJUaXRsZScsXG4vLyAgIH0sXG4vLyAgIHtcbi8vICAgICBjb21wb25lbnQ6ICgpID0+IGltcG9ydCgnYXBwL3NyYy9wYWdlcy9JbmRleFBhZ2UudnVlJyksXG4vLyAgICAgYXV0aDogdHJ1ZSxcbi8vICAgICB0YXJnZXQ6ICdob21lTGlua1RhcmdldCcsXG4vLyAgICAgdGFyZ2V0TmFtZTogJ2hvbWVMaW5rTmFtZScsXG4vLyAgICAgdGl0bGU6ICdob21lVGl0bGUnLFxuLy8gICB9LFxuLy8gICB7XG4vLyAgICAgY29tcG9uZW50OiAoKSA9PiBpbXBvcnQoJ2FwcC9zcmMvcGFnZXMvSW5kZXhQYWdlLnZ1ZScpLFxuLy8gICAgIGF1dGg6IHRydWUsXG4vLyAgICAgdGFyZ2V0OiAnaG9tZVRlckxpbmtUYXJnZXQnLFxuLy8gICAgIHRhcmdldE5hbWU6ICdob21lVGVyTGlua05hbWUnLFxuLy8gICAgIHRpdGxlOiAnaG9tZVRpdGxlJyxcbi8vICAgfSxcbi8vICAge1xuLy8gICAgIGNvbXBvbmVudDogKCkgPT4gaW1wb3J0KCdhcHAvc3JjL3BhZ2VzL1Byb2ZpbGVQYWdlLnZ1ZScpLFxuLy8gICAgIGF1dGg6IHRydWUsXG4vLyAgICAgdGFyZ2V0OiAncHJvZmlsZUxpbmtUYXJnZXQnLFxuLy8gICAgIHRhcmdldE5hbWU6ICdwcm9maWxlTGlua05hbWUnLFxuLy8gICAgIHRpdGxlOiAncHJvZmlsZVRpdGxlJyxcbi8vICAgfSxcbi8vIF07XG5cbmFzeW5jIGZ1bmN0aW9uIHZhbGlkYXRlU2Vzc2lvbihzZXNzaW9uQ29va2llOiBhbnksIHBsYXRmb3JtOiBhbnksIHNlc3Npb25QcmVmOiBhbnkgPSBudWxsKSB7XG4gIGlmIChwbGF0Zm9ybS5pcy5kZXNrdG9wKVxuICAgIHJldHVybiBzZXNzaW9uQXhpb3NTZXJ2aWNlLnZhbGlkYXRlKCEhc2Vzc2lvbkNvb2tpZSA/IHNlc3Npb25Db29raWUuc2Vzc2lvbklkIDogJycpO1xuICBlbHNlIHtcbiAgICBpZiAoKCEhc2Vzc2lvblByZWYgJiYgISFzZXNzaW9uQ29va2llKSAmJiAoc2Vzc2lvblByZWYuc2Vzc2lvbklkID09PSBzZXNzaW9uQ29va2llLnNlc3Npb25JZCkpXG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICBlbHNlXG4gICAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn07XG4vLyBmdW5jdGlvbiBpc1JlYWxQYXRoKHRvOiBzdHJpbmcpIHtcbi8vICAgY29uc3QgcmV0ID0gbnVsbDtcbi8vICAgLy8gY29uc29sZS5sb2coaTE4bi5nbG9iYWwubG9jYWxlLnZhbHVlKTtcbi8vICAgLy8gY29uc29sZS5sb2coYE9iaiBwYXRoIDogYCk7XG4vLyAgIGZvciAoY29uc3Qgb2JqIG9mIHBhdGhzT2JqKSB7XG4vLyAgICAgLy8gY29uc29sZS5sb2codChvYmoudGFyZ2V0KSk7XG4vLyAgICAgaWYgKHRvID09PSB0KG9iai50YXJnZXQpKSB7XG4vLyAgICAgICBjb25zdCByZXQgPSB7fTtcbi8vICAgICAgIHJldC5wYXRoID0gdChvYmoudGFyZ2V0KTtcbi8vICAgICAgIHJldC5jb21wb25lbnQgPSBvYmouY29tcG9uZW50O1xuLy8gICAgICAgcmV0Lm5hbWUgPSB0KG9iai50YXJnZXROYW1lKTtcbi8vICAgICAgIHJldC5hdXRoID0gb2JqLmF1dGg7XG4vLyAgICAgICByZXQudGl0bGUgPSB0KG9iai50aXRsZSk7XG4vLyAgICAgICByZXR1cm4gcmV0O1xuLy8gICAgIH1cbi8vICAgfVxuLy8gICByZXR1cm4gcmV0O1xuLy8gfTtcbmZ1bmN0aW9uIGhhc05lY2Vzc2FyeVJvdXRlKHRvOiBhbnksIHJvdXRlcjogYW55KTogYm9vbGVhbiB7XG4gIGxldCByZXQgPSBmYWxzZTtcbiAgcmV0ID0gcm91dGVyLmhhc1JvdXRlKHRvLm5hbWUpO1xuICByZXR1cm4gcmV0O1xufTtcblxuLy8gZnVuY3Rpb24gZ2VuZXJhdGVSb3V0ZSh0bzogYW55LCBwYXRoT2JqOiBhbnksIHJvdXRlcjogYW55KTogdm9pZCB7XG4vLyAgIGNvbnN0IGNvbXAgPSBwYXRoT2JqLmNvbXBvbmVudDtcbi8vICAgcm91dGVyLmFkZFJvdXRlKCdNYWluJywge1xuLy8gICAgIHBhdGg6IHBhdGhPYmoucGF0aCxcbi8vICAgICBuYW1lOiBwYXRoT2JqLm5hbWUsXG4vLyAgICAgLy8gcm91dGUgbGV2ZWwgY29kZS1zcGxpdHRpbmdcbi8vICAgICAvLyB0aGlzIGdlbmVyYXRlcyBhIHNlcGFyYXRlIGNodW5rIChBYm91dC5baGFzaF0uanMpIGZvciB0aGlzIHJvdXRlXG4vLyAgICAgLy8gd2hpY2ggaXMgbGF6eS1sb2FkZWQgd2hlbiB0aGUgcm91dGUgaXMgdmlzaXRlZC5cbi8vICAgICBjb21wb25lbnQ6IGNvbXAsXG4vLyAgICAgLy8gY29tcG9uZW50OiAoKSA9PiBpbXBvcnQoJ2FwcC9zcmMvcGFnZXMvUmVnaXN0ZXJQYWdlLnZ1ZScpLFxuLy8gICAgIG1ldGE6IHtcbi8vICAgICAgIHRpdGxlOiBwYXRoT2JqLnRpdGxlLFxuLy8gICAgICAgLy8gaWNvbjogaWNvbixcbi8vICAgICAgIHJlcXVpcmVzQXV0aDogcGF0aE9iai5hdXRoLFxuLy8gICAgIH0sXG4vLyAgICAgY2hpbGRyZW46IHBhdGhPYmouY2hpbGRyZW4sXG4vLyAgIH0pO1xuLy8gfTtcblxuYXN5bmMgZnVuY3Rpb24gcm91dGluZ0ZvclNlcnZlcihzdG9yZTogU3RvcmUsIGNvb2tpZTogYW55LCBmcm9tOiBhbnksIHRvOiBhbnksIHJvdXRlcjogYW55LCBwbGF0Zm9ybTogYW55KTogc3RyaW5nIHwgbnVsbHtcbiAgbGV0IHNlc3Npb25Db29raWUgPSBudWxsLCBcbiAgICB1c2VyQ29va2llID0gbnVsbCxcbiAgICBtZXNzYWdlQ29va2llID0gbnVsbDtcbiAgaWYgKCEhY29va2llLmdldEFsbCgpLnNlc3Npb24pe1xuICAgIHNlc3Npb25Db29raWUgPSBKU09OLnBhcnNlKGRlY29kZVVSSUNvbXBvbmVudChjb29raWUuZ2V0QWxsKCkuc2Vzc2lvbikpO1xuICB9XG4gIGlmICghIWNvb2tpZS5nZXRBbGwoKS51c2VyKXtcbiAgICB1c2VyQ29va2llID0gSlNPTi5wYXJzZShkZWNvZGVVUklDb21wb25lbnQoY29va2llLmdldEFsbCgpLnVzZXIpKTtcbiAgfVxuICBpZiAoISFjb29raWUuZ2V0QWxsKCkubWVzc2FnZSl7XG4gICAgbWVzc2FnZUNvb2tpZSA9IEpTT04ucGFyc2UoZGVjb2RlVVJJQ29tcG9uZW50KGNvb2tpZS5nZXRBbGwoKS5tZXNzYWdlKSk7XG4gIH1cbiAgaTE4bi5nbG9iYWwubG9jYWxlLnZhbHVlID0gISFzZXNzaW9uQ29va2llICYmICEhc2Vzc2lvbkNvb2tpZS5sYW5nRGlzcGxheWVkXG4gICAgPyBzZXNzaW9uQ29va2llLmxhbmdEaXNwbGF5ZWQubm9tXG4gICAgOiAnZW4tVVMnO1xuICAvLyBjb25zdCBhY2Nlc3NpYmxlUGF0aCA9IGlzUmVhbFBhdGgodG8uZnVsbFBhdGgpO1xuICBjb25zdCBoYXNSb3V0ZSA9IGhhc05lY2Vzc2FyeVJvdXRlKHRvLCByb3V0ZXIpO1xuICBjb25zdCByZXF1aXJlQXV0aCA9IHRvLm1ldGEucmVxdWlyZXNBdXRoO1xuICAvLyBkZWJ1Z1JvdXRlKGZyb20sIHRvLCBoYXNSb3V0ZSwgcmVxdWlyZUF1dGgsIHNlc3Npb25Db29raWUsIHVzZXJDb29raWUsIG1lc3NhZ2VDb29raWUpO1xuICBpZiAocmVxdWlyZUF1dGggJiYgISF1c2VyQ29va2llICYmICF1c2VyQ29va2llLmNvbm5lY3RlZCkge1xuICAgIC8vIGNvbnNvbGUubG9nKGBTZXNzaW9uIE1hbmFnZW1lbnQ6ICR7c2Vzc2lvblN0b3JlLmdldFNlc3Npb25JZH1gKTtcbiAgICByZXR1cm4gYXdhaXQgdmFsaWRhdGVTZXNzaW9uKHNlc3Npb25Db29raWUsIHBsYXRmb3JtKVxuICAgICAgLnRoZW4oXG4gICAgICAgICgpID0+IHtcbiAgICAgICAgICAvLyBjb25zb2xlLmxvZygnU2Vzc2lvbiB2YWxpZGF0ZSBvbiBzZXJ2ZXIgc2lkZSAhJyk7XG4gICAgICAgICAgaWYgKCEhdXNlckNvb2tpZS51c2VyIFxuICAgICAgICAgICAgJiYgT2JqZWN0LmtleXModXNlckNvb2tpZS51c2VyKS5sZW5ndGhcbiAgICAgICAgICAgICYmIE9iamVjdC5nZXRQcm90b3R5cGVPZih1c2VyQ29va2llLnVzZXIpID09PSBPYmplY3QucHJvdG90eXBlKXtcbiAgICAgICAgICAgIHVzZXJDb29raWUuY29ubmVjdGVkID0gdHJ1ZTtcbiAgICAgICAgICAgIGNvb2tpZS5zZXQoJ3VzZXInLCBKU09OLnN0cmluZ2lmeSh1c2VyQ29va2llKSwge3BhdGg6ICcvJywgc2FtZVNpdGU6ICdMYXgnLCBzZWN1cmU6IGZhbHNlfSk7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICB9XG4gICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBtZXNzYWdlQ29va2llLm1lc3NhZ2VzID0gW3tzZXZlcml0eTogdHJ1ZSwgY29udGVudDogdCgnc2Vzc2lvbi5yZXN1bHRzLmtvJyl9XTtcbiAgICAgICAgICAgIG1lc3NhZ2VDb29raWUubWVzc2FnZXNWaXNpYmlsaXR5ID0gdHJ1ZTtcbiAgICAgICAgICAgIGNvb2tpZS5zZXQoJ21lc3NhZ2UnLCBKU09OLnN0cmluZ2lmeShtZXNzYWdlQ29va2llKSwge3BhdGg6ICcvJywgc2FtZVNpdGU6ICdMYXgnLCBzZWN1cmU6IGZhbHNlfSk7XG4gICAgICAgICAgICByZXR1cm4gdCgnc3RhcnRMaW5rVGFyZ2V0Jyk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApXG4gICAgICAuY2F0Y2goKCkgPT4ge1xuICAgICAgICAvLyBjb25zb2xlLmxvZygnU2Vzc2lvbiBpbnZhbGlkYXRlIG9uIHNlcnZlciBzaWRlICEnKTtcbiAgICAgICAgdXNlckNvb2tpZS51c2VyID0ge307XG4gICAgICAgIHVzZXJDb29raWUuY29ubmVjdGVkID0gdHJ1ZTtcbiAgICAgICAgaWYgKHNlc3Npb25Db29raWUgJiYgc2Vzc2lvbkNvb2tpZS5zZXNzaW9uSWQgIT0gJycpe1xuICAgICAgICAgIG1lc3NhZ2VDb29raWUubWVzc2FnZXMgPSBbe3NldmVyaXR5OiB0cnVlLCBjb250ZW50OiB0KCdzZXNzaW9uLnJlc3VsdHMua28nKX1dO1xuICAgICAgICAgIG1lc3NhZ2VDb29raWUubWVzc2FnZXNWaXNpYmlsaXR5ID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICBtZXNzYWdlQ29va2llLm1lc3NhZ2VzID0gW107XG4gICAgICAgICAgbWVzc2FnZUNvb2tpZS5tZXNzYWdlc1Zpc2liaWxpdHkgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBjb29raWUuc2V0KCd1c2VyJywgSlNPTi5zdHJpbmdpZnkodXNlckNvb2tpZSksIHtwYXRoOiAnLycsIHNhbWVTaXRlOiAnTGF4Jywgc2VjdXJlOiBmYWxzZX0pO1xuICAgICAgICBjb29raWUuc2V0KCdtZXNzYWdlJywgSlNPTi5zdHJpbmdpZnkobWVzc2FnZUNvb2tpZSksIHtwYXRoOiAnLycsIHNhbWVTaXRlOiAnTGF4Jywgc2VjdXJlOiBmYWxzZX0pO1xuICAgICAgICByZXR1cm4gdCgnc3RhcnRMaW5rVGFyZ2V0Jyk7XG4gICAgICB9KTtcbiAgfSBcbiAgLy8gZWxzZSBpZiAoIWhhc1JvdXRlICYmIGFjY2Vzc2libGVQYXRoICE9PSBudWxsKSB7XG4gIC8vICAgLy8gY29uc29sZS5sb2coJ0dlbmVyYXRlIHJvdXRlICEnKTtcbiAgLy8gICBnZW5lcmF0ZVJvdXRlKHRvLCBhY2Nlc3NpYmxlUGF0aCwgcm91dGVyKTtcbiAgLy8gICByZXR1cm4gKHRvLmZ1bGxQYXRoKTtcbiAgLy8gfVxuICBlbHNlIGlmKGhhc1JvdXRlICYmIHRvLmZ1bGxQYXRoICE9PSAnLycpIHtcbiAgICAvLyBjb25zb2xlLmxvZygnSGFzIFJvdXRlICE9PSBcXCcvXFwnIHNvIEdvIG9uICEnKTtcbiAgICBpZiAodG8uZnVsbFBhdGggPT09IHQoJ3N0YXJ0TGlua1RhcmdldCcpKXtcbiAgICAgIGlmICh1c2VyQ29va2llID09PSBudWxsKXtcbiAgICAgICAgdXNlckNvb2tpZSA9IHt9O1xuICAgICAgICB1c2VyQ29va2llLnVzZXIgPSB7fTtcbiAgICAgIH1cbiAgICAgIHVzZXJDb29raWUuY29ubmVjdGVkID0gZmFsc2U7XG4gICAgICBjb29raWUuc2V0KCd1c2VyJywgSlNPTi5zdHJpbmdpZnkodXNlckNvb2tpZSksIHtwYXRoOiAnLycsIHNhbWVTaXRlOiAnTGF4Jywgc2VjdXJlOiBmYWxzZX0pO1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICBlbHNlIGlmKHVzZXJDb29raWUgPT09IG51bGwgXG4gICAgfHwgKCFPYmplY3Qua2V5cyh1c2VyQ29va2llLnVzZXIpLmxlbmd0aFxuICAgICYmIE9iamVjdC5nZXRQcm90b3R5cGVPZih1c2VyQ29va2llLnVzZXIpID09PSBPYmplY3QucHJvdG90eXBlKVxuICAgICYmIGhhc1JvdXRlKSB7XG4gICAgLy8gY29uc29sZS5sb2coJ1VzZXJDb29raWUgY29ycnVwdGVkIEdvIHRvIHN0YXJ0ICEnKTtcbiAgICBpZiAodXNlckNvb2tpZSA9PT0gbnVsbCl7XG4gICAgICB1c2VyQ29va2llID0ge307XG4gICAgICB1c2VyQ29va2llLnVzZXIgPSB7fTtcbiAgICB9XG4gICAgdXNlckNvb2tpZS5jb25uZWN0ZWQgPSBmYWxzZTtcbiAgICBjb29raWUuc2V0KCd1c2VyJywgSlNPTi5zdHJpbmdpZnkodXNlckNvb2tpZSksIHtwYXRoOiAnLycsIHNhbWVTaXRlOiAnTGF4Jywgc2VjdXJlOiBmYWxzZX0pO1xuICAgIHJldHVybiB0KCdzdGFydExpbmtUYXJnZXQnKTtcbiAgfVxuICBlbHNlIHJldHVybiBudWxsO1xufTtcblxuYXN5bmMgZnVuY3Rpb24gcm91dGluZ0ZvckNsaWVudChzdG9yZTogU3RvcmUsIGNvb2tpZTogYW55LCBmcm9tOiBhbnksIHRvOiBhbnksIHJvdXRlcjogYW55LCBwbGF0Zm9ybTogYW55KXtcbiAgbGV0IHNlc3Npb25Db29raWUgPSBudWxsLCBcbiAgICB1c2VyQ29va2llID0gbnVsbCxcbiAgICBtZXNzYWdlQ29va2llID0gbnVsbDtcbiAgaWYgKCEhY29va2llLmdldEFsbCgpLnNlc3Npb24pe1xuICAgIHNlc3Npb25Db29raWUgPSBKU09OLnBhcnNlKGRlY29kZVVSSUNvbXBvbmVudChjb29raWUuZ2V0QWxsKCkuc2Vzc2lvbikpO1xuICB9XG4gIGlmICghIWNvb2tpZS5nZXRBbGwoKS51c2VyKXtcbiAgICB1c2VyQ29va2llID0gSlNPTi5wYXJzZShkZWNvZGVVUklDb21wb25lbnQoY29va2llLmdldEFsbCgpLnVzZXIpKTtcbiAgfVxuICBpZiAoISFjb29raWUuZ2V0QWxsKCkubWVzc2FnZSl7XG4gICAgbWVzc2FnZUNvb2tpZSA9IEpTT04ucGFyc2UoZGVjb2RlVVJJQ29tcG9uZW50KGNvb2tpZS5nZXRBbGwoKS5tZXNzYWdlKSk7XG4gIH1cblxuICBpMThuLmdsb2JhbC5sb2NhbGUudmFsdWUgPSAhIXNlc3Npb25Db29raWUgJiYgISFzZXNzaW9uQ29va2llLmxhbmdEaXNwbGF5ZWRcbiAgICA/IHNlc3Npb25Db29raWUubGFuZ0Rpc3BsYXllZC5ub21cbiAgICA6ICdlbi1VUyc7XG4gIC8vIGNvbnN0IGFjY2Vzc2libGVQYXRoID0gaXNSZWFsUGF0aCh0by5mdWxsUGF0aCk7XG4gIGNvbnN0IGhhc1JvdXRlID0gaGFzTmVjZXNzYXJ5Um91dGUodG8sIHJvdXRlcik7XG4gIGNvbnN0IHJlcXVpcmVBdXRoID0gdG8ubWV0YS5yZXF1aXJlc0F1dGg7XG4gIC8vIGRlYnVnUm91dGUoZnJvbSwgdG8sIGhhc1JvdXRlLCByZXF1aXJlQXV0aCwgc2Vzc2lvbkNvb2tpZSwgdXNlckNvb2tpZSwgbWVzc2FnZUNvb2tpZSwgc3RvcmUpO1xuICBpZiAocmVxdWlyZUF1dGggJiYgISF1c2VyQ29va2llICYmICF1c2VyQ29va2llLmNvbm5lY3RlZCkge1xuICAgIHJldHVybiBhd2FpdCB2YWxpZGF0ZVNlc3Npb24oc2Vzc2lvbkNvb2tpZSwgcGxhdGZvcm0pXG4gICAgICAudGhlbihcbiAgICAgICAgKCkgPT4ge1xuICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdTZXNzaW9uIHZhbGlkYXRlIG9uIGNsaWVudCBzaWRlICEnKTtcbiAgICAgICAgICBpZiAoISF1c2VyQ29va2llLnVzZXIgXG4gICAgICAgICAgICAmJiBPYmplY3Qua2V5cyh1c2VyQ29va2llLnVzZXIpLmxlbmd0aFxuICAgICAgICAgICAgJiYgT2JqZWN0LmdldFByb3RvdHlwZU9mKHVzZXJDb29raWUudXNlcikgPT09IE9iamVjdC5wcm90b3R5cGUpe1xuICAgICAgICAgICAgc3RvcmUudXNlci5jb25uZWN0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgdXNlckNvb2tpZS5jb25uZWN0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgY29va2llLnNldCgndXNlcicsIEpTT04uc3RyaW5naWZ5KHVzZXJDb29raWUpLCB7cGF0aDogJy8nLCBzYW1lU2l0ZTogJ0xheCcsIHNlY3VyZTogZmFsc2V9KTtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgIH1cbiAgICAgICAgICBlbHNle1xuICAgICAgICAgICAgcmV0dXJuIHQoJ3N0YXJ0TGlua1RhcmdldCcpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgKVxuICAgICAgLmNhdGNoKCgpID0+IHtcbiAgICAgICAgLy8gY29uc29sZS5sb2coJ1Nlc3Npb24gaW52YWxpZGF0ZSBvbiBjbGllbnQgc2lkZSAhJyk7XG4gICAgICAgIGlmICghIXN0b3JlIFxuICAgICAgICAgICYmIE9iamVjdC5rZXlzKHN0b3JlKS5sZW5ndGhcbiAgICAgICAgICAmJiBPYmplY3QuZ2V0UHJvdG90eXBlT2Yoc3RvcmUpID09PSBPYmplY3QucHJvdG90eXBlKXtcbiAgICAgICAgICBzdG9yZS51c2VyLnVzZXIgPSBbXTtcbiAgICAgICAgICBzdG9yZS51c2VyLmNvbm5lY3RlZCA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzdG9yZS5zZXNzaW9uICYmIHN0b3JlLnNlc3Npb24uc2Vzc2lvbklkICE9ICcnKXtcbiAgICAgICAgICBzdG9yZS5tZXNzYWdlLm1lc3NhZ2VzLnB1c2goe1xuICAgICAgICAgICAgICBzZXZlcml0eTogdHJ1ZSxcbiAgICAgICAgICAgICAgY29udGVudDogdCgnc2Vzc2lvbi5yZXN1bHRzLmtvJyksXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICBzdG9yZS5tZXNzYWdlLm1lc3NhZ2VzVmlzaWJpbGl0eSA9IHRydWU7IFxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgIGlmICghIXN0b3JlIFxuICAgICAgICAgICYmIE9iamVjdC5rZXlzKHN0b3JlKS5sZW5ndGhcbiAgICAgICAgICAmJiBPYmplY3QuZ2V0UHJvdG90eXBlT2Yoc3RvcmUpID09PSBPYmplY3QucHJvdG90eXBlKXtcbiAgICAgICAgICAgIHN0b3JlLm1lc3NhZ2UubWVzc2FnZXMgPSBbXTtcbiAgICAgICAgICAgIHN0b3JlLm1lc3NhZ2UubWVzc2FnZXNWaXNpYmlsaXR5ID0gZmFsc2U7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0KCdzdGFydExpbmtUYXJnZXQnKTtcbiAgICAgIH0pO1xuICB9IFxuICAvLyBlbHNlIGlmICghaGFzUm91dGUgJiYgYWNjZXNzaWJsZVBhdGggIT09IG51bGwpIHtcbiAgLy8gICAvLyBjb25zb2xlLmxvZygnR2VuZXJhdGUgcm91dGUgIScpO1xuICAvLyAgIGdlbmVyYXRlUm91dGUodG8sIGFjY2Vzc2libGVQYXRoLCByb3V0ZXIpO1xuICAvLyAgIHJldHVybiB0by5mdWxsUGF0aDtcbiAgLy8gfVxuICBlbHNlIGlmKGhhc1JvdXRlICYmIHRvLmZ1bGxQYXRoICE9PSAnLycpIHtcbiAgICAvLyBjb25zb2xlLmxvZygnSGFzIFJvdXRlICE9PSBcXCcvXFwnIHNvIEdvIG9uICEnKTtcbiAgICBpZiAodG8uZnVsbFBhdGggPT09IHQoJ3N0YXJ0TGlua1RhcmdldCcpKXtcbiAgICAgIGlmICh1c2VyQ29va2llID09PSBudWxsKXtcbiAgICAgICAgdXNlckNvb2tpZSA9IHt9O1xuICAgICAgICB1c2VyQ29va2llLnVzZXIgPSB7fTtcbiAgICAgIH1cbiAgICAgIHVzZXJDb29raWUuY29ubmVjdGVkID0gZmFsc2U7XG4gICAgICBjb29raWUuc2V0KCd1c2VyJywgSlNPTi5zdHJpbmdpZnkodXNlckNvb2tpZSksIHtwYXRoOiAnLycsIHNhbWVTaXRlOiAnTGF4Jywgc2VjdXJlOiBmYWxzZX0pO1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICBlbHNlIGlmKHVzZXJDb29raWUgPT09IG51bGxcbiAgICB8fCAoIU9iamVjdC5rZXlzKHVzZXJDb29raWUudXNlcikubGVuZ3RoXG4gICAgJiYgT2JqZWN0LmdldFByb3RvdHlwZU9mKHVzZXJDb29raWUudXNlcikgPT09IE9iamVjdC5wcm90b3R5cGUpXG4gICAgJiYgaGFzUm91dGUpIHtcbiAgICAvLyBjb25zb2xlLmxvZygnVXNlckNvb2tpZSBjb3JydXB0ZWQgR28gdG8gc3RhcnQgIScpO1xuICAgIGlmICh1c2VyQ29va2llID09PSBudWxsKXtcbiAgICAgIHVzZXJDb29raWUgPSB7fTtcbiAgICAgIHVzZXJDb29raWUudXNlciA9IHt9O1xuICAgIH1cbiAgICB1c2VyQ29va2llLmNvbm5lY3RlZCA9IGZhbHNlO1xuICAgIGNvb2tpZS5zZXQoJ3VzZXInLCBKU09OLnN0cmluZ2lmeSh1c2VyQ29va2llKSwge3BhdGg6ICcvJywgc2FtZVNpdGU6ICdMYXgnLCBzZWN1cmU6IGZhbHNlfSk7XG4gICAgcmV0dXJuIHQoJ3N0YXJ0TGlua1RhcmdldCcpO1xuICB9XG4gIGVsc2UgcmV0dXJuIG51bGw7XG59O1xuXG5mdW5jdGlvbiBkZWJ1Z1JvdXRlKGZyb206IGFueSwgdG86IGFueSwgaGFzUm91dGU6IGJvb2xlYW4sIHJlcXVpcmVBdXRoOiBib29sZWFuLCBzZXNzaW9uQ29va2llOiBhbnksIHVzZXJDb29raWU6IGFueSwgbWVzc2FnZUNvb2tpZTogYW55LCBzdG9yZTogU3RvcmUgPSBudWxsKXtcbiAgLy8gREFUQVMgREVCVUdcbiAgY29uc29sZS5sb2coJy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cXFxcJyk7XG4gIGNvbnNvbGUubG9nKCcvLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXFxcXCcpO1xuICAvLyBST1VURSBOQVZJR0FUSU9OIERFQlVHXG4gIGNvbnNvbGUubG9nKCdmcm9tIC0tPiAnKTtcbiAgY29uc29sZS5sb2coZnJvbSk7XG4gIGNvbnNvbGUubG9nKCd0byAtLT4gJyk7XG4gIGNvbnNvbGUubG9nKHRvKTtcbiAgY29uc29sZS5sb2coYGhhcyByb3V0ZSA/IC0tPiAke2hhc1JvdXRlfWApO1xuICAvLyBjb25zb2xlLmxvZygnYWNjZXNzaWJsZSA/IC0tPiAnKTtcbiAgLy8gY29uc29sZS5sb2coYWNjZXNzaWJsZVBhdGgpO1xuICBjb25zb2xlLmxvZyhgcmVxdWlyZSBBdXRoID8gLS0+ICR7cmVxdWlyZUF1dGh9YCk7XG4gIGNvbnNvbGUubG9nKGBjdXJyZW50IExvY2FsIC0tPiAke2kxOG4uZ2xvYmFsLmxvY2FsZS52YWx1ZX1gKTtcbiAgY29uc29sZS5sb2coJy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cXFxcJyk7XG4gIGlmIChpbXBvcnQubWV0YS5lbnYuU1NSKXtcbiAgICBjb25zb2xlLmxvZygnQ29va2llIFNlc3Npb24gb24gdGhlIHNlcnZlciAtLT4gJyk7XG4gICAgY29uc29sZS5sb2coc2Vzc2lvbkNvb2tpZSk7XG4gICAgY29uc29sZS5sb2coJ0Nvb2tpZSBNZXNzYWdlIG9uIHRoZSBzZXJ2ZXIgLS0+ICcpO1xuICAgIGNvbnNvbGUubG9nKG1lc3NhZ2VDb29raWUpO1xuICAgIGNvbnNvbGUubG9nKCdDb29raWUgVXNlciBvbiB0aGUgc2VydmVyIC0tPiAnKTtcbiAgICBjb25zb2xlLmxvZyh1c2VyQ29va2llKTtcbiAgfVxuICBlbHNlIHtcbiAgICBjb25zb2xlLmxvZygnU2Vzc2lvbiBTdG9yZSBvbiB0aGUgY2xpZW50IC0tPiAnKTtcbiAgICBjb25zb2xlLmxvZyhzdG9yZS5zZXNzaW9uKTtcbiAgICBjb25zb2xlLmxvZygnTWVzc2FnZSBTdG9yZSBvbiB0aGUgY2xpZW50IC0tPiAnKTtcbiAgICBjb25zb2xlLmxvZyhzdG9yZS5tZXNzYWdlKTtcbiAgICBjb25zb2xlLmxvZygnVXNlciBTdG9yZSBvbiB0aGUgY2xpZW50IC0tPiAnKTtcbiAgICBjb25zb2xlLmxvZyhzdG9yZS51c2VyKTtcbiAgICBjb25zb2xlLmxvZygnLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxcXFwnKTtcbiAgICBjb25zb2xlLmxvZygnQ29va2llIFNlc3Npb24gb24gdGhlIGNsaWVudCAtLT4gJyk7XG4gICAgY29uc29sZS5sb2coc2Vzc2lvbkNvb2tpZSk7XG4gICAgY29uc29sZS5sb2coJ0Nvb2tpZSBNZXNzYWdlIG9uIHRoZSBjbGllbnQgLS0+ICcpO1xuICAgIGNvbnNvbGUubG9nKG1lc3NhZ2VDb29raWUpO1xuICAgIGNvbnNvbGUubG9nKCdDb29raWUgVXNlciBvbiB0aGUgY2xpZW50IC0tPiAnKTtcbiAgICBjb25zb2xlLmxvZyh1c2VyQ29va2llKTtcbiAgfVxuICBjb25zb2xlLmxvZygnLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLScpO1xuICBjb25zb2xlLmxvZygnLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxcXFxcXG5cXG4nKTtcbn07XG5cbmFzeW5jIGZ1bmN0aW9uIGNoZWNrRm9yV2ViKHRvOiBhbnksIGZyb206IGFueSwgbmV4dDogYW55LCByb3V0ZXI6IGFueSwgY29va2llOiBhbnksIHBsYXRmb3JtOiBhbnksIHN0b3JlOiBTdG9yZSA9IG51bGwpIHtcbiAgbGV0IGRlc3QgPSBudWxsO1xuICBpZiAoaW1wb3J0Lm1ldGEuZW52LlNTUil7XG4gICAgZGVzdCA9IGF3YWl0IHJvdXRpbmdGb3JTZXJ2ZXIoc3RvcmUsIGNvb2tpZSwgZnJvbSwgdG8sIHJvdXRlciwgcGxhdGZvcm0pO1xuICAgIC8vIGNvbnNvbGUubG9nKGBTZXJ2ZXIgZGVzdCAtLT4gJHtkZXN0fWApO1xuICB9XG4gIGVsc2Uge1xuICAgIGRlc3QgPSBhd2FpdCByb3V0aW5nRm9yQ2xpZW50KHN0b3JlLCBjb29raWUsIGZyb20sIHRvLCByb3V0ZXIsIHBsYXRmb3JtKTtcbiAgICAvLyBjb25zb2xlLmxvZyhgQ2xpZW50IGRlc3QgLS0+ICR7ZGVzdH1gKTtcbiAgfVxuICBpZighIWRlc3QpXG4gICAgbmV4dChkZXN0KTtcbiAgZWxzZVxuICAgIG5leHQoKTtcbn07XG5cbmFzeW5jIGZ1bmN0aW9uIGNoZWNrRm9yTW9iaWxlcyh0bzogYW55LCBmcm9tOiBhbnksIG5leHQ6IGFueSwgcm91dGVyOiBhbnksIGNvb2tpZTogYW55LCBwbGF0Zm9ybTogYW55KSB7XG4gIC8vIGNvbnNvbGUubG9nKCdSb3V0ZSBOYXZpZ2F0aW9uIEZvciBNb2JpbGVzICEnKTtcbiAgbGV0IHNlc3Npb25Db29raWUgPSBudWxsLCB1c2VyQ29va2llID0gbnVsbDtcbiAgaWYgKCEhY29va2llLmdldEFsbCgpLnNlc3Npb24pe1xuICAgIHNlc3Npb25Db29raWUgPSBKU09OLnBhcnNlKGRlY29kZVVSSUNvbXBvbmVudChjb29raWUuZ2V0QWxsKCkuc2Vzc2lvbikpO1xuICB9XG4gIGlmICghIWNvb2tpZS5nZXRBbGwoKS51c2VyKXtcbiAgICB1c2VyQ29va2llID0gSlNPTi5wYXJzZShkZWNvZGVVUklDb21wb25lbnQoY29va2llLmdldEFsbCgpLnVzZXIpKTtcbiAgfVxuICBpMThuLmdsb2JhbC5sb2NhbGUudmFsdWUgPSAhIXNlc3Npb25Db29raWUgJiYgISFzZXNzaW9uQ29va2llLmxhbmdEaXNwbGF5ZWRcbiAgICA/IHNlc3Npb25Db29raWUubGFuZ0Rpc3BsYXllZC5ub21cbiAgICA6ICdlbi1VUyc7XG4gIC8vIGNvbnN0IGFjY2Vzc2libGVQYXRoID0gaXNSZWFsUGF0aCh0by5mdWxsUGF0aCk7XG4gIGNvbnN0IGhhc1JvdXRlID0gaGFzTmVjZXNzYXJ5Um91dGUodG8sIHJvdXRlcik7XG4gIGNvbnN0IHJlcXVpcmVBdXRoID0gdG8ubWV0YS5yZXF1aXJlc0F1dGg7XG4gIC8vIGRlYnVnUm91dGUoZnJvbSwgdG8sIGhhc1JvdXRlLCByZXF1aXJlQXV0aCwgc2Vzc2lvbkNvb2tpZSwgdXNlckNvb2tpZSk7XG4gIGlmIChyZXF1aXJlQXV0aCAmJiAhIXVzZXJDb29raWUgJiYgIXVzZXJDb29raWUuY29ubmVjdGVkKSB7XG4gICAgY29uc3Qgc2Vzc2lvblByZWYgPSBhd2FpdCBwcmVmcy5nZXRQcmVmKCdzZXNzaW9uJyk7XG4gICAgLy8gY29uc29sZS5sb2coJ1NlZXNpb24gUHJlZnMnKTtcbiAgICAvLyBjb25zb2xlLmxvZyhzZXNzaW9uUHJlZik7XG4gICAgY29uc3QgcmVzID0gYXdhaXQgdmFsaWRhdGVTZXNzaW9uKHNlc3Npb25Db29raWUsIHBsYXRmb3JtLCBzZXNzaW9uUHJlZik7XG4gICAgaWYgKHJlcyl7XG4gICAgICBjb25zb2xlLmxvZygnU2Vzc2lvbiB2YWxpZGF0ZWQgIScpO1xuICAgICAgaWYgKCEhdXNlckNvb2tpZS51c2VyIFxuICAgICAgICAmJiBPYmplY3Qua2V5cyh1c2VyQ29va2llLnVzZXIpLmxlbmd0aFxuICAgICAgICAmJiBPYmplY3QuZ2V0UHJvdG90eXBlT2YodXNlckNvb2tpZS51c2VyKSA9PT0gT2JqZWN0LnByb3RvdHlwZSl7XG4gICAgICAgIHVzZXJDb29raWUuY29ubmVjdGVkID0gdHJ1ZTtcbiAgICAgICAgYXdhaXQgcHJlZnMuc2V0UHJlZigndXNlcicsIHVzZXJDb29raWUpO1xuICAgICAgICAvLyBjb29raWUuc2V0KCd1c2VyJywgSlNPTi5zdHJpbmdpZnkodXNlckNvb2tpZSksIHtwYXRoOiAnLycsIHNhbWVTaXRlOiAnTGF4Jywgc2VjdXJlOiBmYWxzZX0pO1xuICAgICAgICBuZXh0KCk7XG4gICAgICB9XG4gICAgICBlbHNle1xuICAgICAgICBhd2FpdCBwcmVmcy5zZXRQcmVmKCdtZXNzYWdlJywge1xuICAgICAgICAgIG1lc3NhZ2VzOiBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIHNldmVyaXR5OiB0cnVlLCBcbiAgICAgICAgICAgICAgY29udGVudDogdCgnc2Vzc2lvbi5yZXN1bHRzLmtvJylcbiAgICAgICAgICAgIH1cbiAgICAgICAgICBdLFxuICAgICAgICAgIG1lc3NhZ2VzVmlzaWJpbGl0eTogdHJ1ZVxuICAgICAgICB9KTtcbiAgICAgICAgLy8gY29va2llLnNldCgnbWVzc2FnZScsIEpTT04uc3RyaW5naWZ5KHttZXNzYWdlczogW3tzZXZlcml0eTogdHJ1ZSwgY29udGVudDogdCgnc2Vzc2lvbi5yZXN1bHRzLmtvJyl9XSwgbWVzc2FnZXNWaXNpYmlsaXR5OiB0cnVlfSksIHtwYXRoOiAnLycsIHNhbWVTaXRlOiAnTGF4Jywgc2VjdXJlOiBmYWxzZX0pO1xuICAgICAgICBuZXh0KHQoJ3N0YXJ0TGlua1RhcmdldCcpKTtcbiAgICAgIH1cbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICBjb25zb2xlLmxvZygnU2Vzc2lvbiB1bnZhbGlkYXRlZCAhJyk7XG4gICAgICBhd2FpdCBwcmVmcy5zZXRQcmVmKCd1c2VyJywge2Nvbm5lY3RlZDogZmFsc2UsIHVzZXI6IHt9fSk7XG4gICAgICBpZiAoc2Vzc2lvbkNvb2tpZSAmJiBzZXNzaW9uQ29va2llLnNlc3Npb25JZCAhPT0gJycpe1xuICAgICAgICBhd2FpdCBwcmVmcy5zZXRQcmVmKCdtZXNzYWdlJywge1xuICAgICAgICAgIG1lc3NhZ2VzOiBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIHNldmVyaXR5OiB0cnVlLFxuICAgICAgICAgICAgICBjb250ZW50OiB0KCdzZXNzaW9uLnJlc3VsdHMua28nKSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgXSwgXG4gICAgICAgICAgbWVzc2FnZXNWaXNpYmlsaXR5OiB0cnVlXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgZWxzZSB7XG4gICAgICAgIGF3YWl0IHByZWZzLnNldFByZWYoJ21lc3NhZ2UnLCB7XG4gICAgICAgICAgbWVzc2FnZXM6IFtdLCBcbiAgICAgICAgICBtZXNzYWdlc1Zpc2liaWxpdHk6IGZhbHNlXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgbmV4dCh0KCdzdGFydExpbmtUYXJnZXQnKSk7XG4gICAgfVxuICB9XG4gIC8vIGVsc2UgaWYgKCFoYXNSb3V0ZSAmJiBhY2Nlc3NpYmxlUGF0aCAhPT0gbnVsbCkge1xuICAvLyAgIC8vIGNvbnNvbGUubG9nKCdHZW5lcmF0aW5nIHJvdXRlJyk7XG4gIC8vICAgZ2VuZXJhdGVSb3V0ZSh0bywgYWNjZXNzaWJsZVBhdGgsIHJvdXRlcik7XG4gIC8vICAgLy8gdHJpZ2dlciBhIHJlZGlyZWN0aW9uXG4gIC8vICAgbmV4dCh0by5mdWxsUGF0aCk7XG4gIC8vIH1cbiAgZWxzZSBpZiAoaGFzUm91dGUgJiYgdG8uZnVsbFBhdGggIT09ICcvJykge1xuICAgIG5leHQoKTtcbiAgfVxuICBlbHNlIGlmKHVzZXJDb29raWUgPT09IG51bGwgJiYgaGFzUm91dGUpIHtcbiAgICAvLyBjb25zb2xlLmxvZygnTnVsbCB1c2VyIGNvb2tpZSAhJyk7XG4gICAgbmV4dCh0KCdzdGFydExpbmtUYXJnZXQnKSk7XG4gIH1cbiAgZWxzZSBuZXh0KCk7XG59O1xuXG5leHBvcnQgZGVmYXVsdCAoeyBzdG9yZSwgcm91dGVyLCBzc3JDb250ZXh0IH0pID0+IHtcbiAgLy8gY29uc29sZS5sb2coc3RvcmUuc3RhdGUudmFsdWUpO1xuXHRjb25zdCBwbGF0Zm9ybSA9IHByb2Nlc3MuZW52LlNFUlZFUlxuXHRcdD8gUGxhdGZvcm0ucGFyc2VTU1Ioc3NyQ29udGV4dClcblx0XHQ6IFBsYXRmb3JtO1xuXHRjb25zdCBjb29raWVzID0gcHJvY2Vzcy5lbnYuU0VSVkVSXG5cdFx0PyBDb29raWVzLnBhcnNlU1NSKHNzckNvbnRleHQpXG5cdFx0OiBDb29raWVzO1xuXHRyb3V0ZXIuYmVmb3JlRWFjaChhc3luYyh0bzogYW55LCBmcm9tOiBhbnksIG5leHQ6IGFueSkgPT4ge1xuICAgICAgaWYgKHBsYXRmb3JtLmlzLmRlc2t0b3ApIHtcblx0ICAgICAgYXdhaXQgY2hlY2tGb3JXZWIodG8sIGZyb20sIG5leHQsIHJvdXRlciwgY29va2llcywgcGxhdGZvcm0sIHN0b3JlLnN0YXRlLnZhbHVlKTtcblx0ICAgIH1cblx0ICAgIGVsc2Uge1xuXHQgICAgICBhd2FpdCBjaGVja0Zvck1vYmlsZXModG8sIGZyb20sIG5leHQsIHJvdXRlciwgY29va2llcywgcGxhdGZvcm0pO1xuXHQgICAgfVxuICBcdH0pO1xufTsiXSwibmFtZXMiOlsicHJlZnMuZ2V0UHJlZiIsInByZWZzLnNldFByZWYiLCJDb29raWVzIl0sIm1hcHBpbmdzIjoiOzs7OztBQVFBLE1BQU0sSUFBSSxLQUFLLE9BQU87QUF1Q3RCLGVBQWUsZ0JBQWdCLGVBQW9CLFVBQWUsY0FBbUIsTUFBTTtBQUN6RixNQUFJLFNBQVMsR0FBRztBQUNkLFdBQU8sb0JBQW9CLFNBQVMsQ0FBQyxDQUFDLGdCQUFnQixjQUFjLFlBQVksRUFBRTtBQUFBLE9BQy9FO0FBQ0UsUUFBQSxDQUFDLENBQUMsZUFBZSxDQUFDLENBQUMsaUJBQW1CLFlBQVksY0FBYyxjQUFjO0FBQzFFLGFBQUE7QUFBQTtBQUVBLGFBQUE7QUFBQSxFQUNYO0FBQ0Y7QUFtQkEsU0FBUyxrQkFBa0IsSUFBUyxRQUFzQjtBQUN4RCxNQUFJLE1BQU07QUFDSixRQUFBLE9BQU8sU0FBUyxHQUFHLElBQUk7QUFDdEIsU0FBQTtBQUNUO0FBZ0hBLGVBQWUsaUJBQWlCLE9BQWMsUUFBYSxNQUFXLElBQVMsUUFBYSxVQUFjO0FBQ3hHLE1BQUksZ0JBQWdCLE1BQ2xCLGFBQWE7QUFFZixNQUFJLENBQUMsQ0FBQyxPQUFPLE9BQUEsRUFBUyxTQUFRO0FBQzVCLG9CQUFnQixLQUFLLE1BQU0sbUJBQW1CLE9BQU8sT0FBTyxFQUFFLE9BQU8sQ0FBQztBQUFBLEVBQ3hFO0FBQ0EsTUFBSSxDQUFDLENBQUMsT0FBTyxP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
